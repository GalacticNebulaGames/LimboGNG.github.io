<script>
    let keys = [];
    let correctKeyIndex;
    let shuffleInterval;
    let audio = document.getElementById("bgMusic");
    let keysClickable = false;
    let shuffleStep = 0; // new counter for pattern steps

    function createKeys() {
        let container = document.getElementById("keyContainer");
        container.innerHTML = "";
        keys = [];
        for (let i = 0; i < 8; i++) {
            let key = document.createElement("div");
            key.classList.add("key");
            key.dataset.index = i;
            key.onclick = () => {
                if (keysClickable) checkKey(i);
            };
            key.style.backgroundImage = 'url("Key.png")';
            keys.push(key);
            container.appendChild(key);
        }
    }

    function startGame() {
        document.querySelector("button").style.display = "none";
        document.getElementById("game").style.display = "block";
        createKeys();
        correctKeyIndex = Math.floor(Math.random() * 8);
        keys[correctKeyIndex].style.backgroundImage = 'url("KeyGF.png")';
        
        audio.currentTime = 180;
        audio.play();
        
        setTimeout(() => {
            keys[correctKeyIndex].style.backgroundImage = 'url("Key.png")';
            shuffleKeys();
        }, 800);
    }

    function shuffleKeys() {
        keysClickable = false;
        let startTime = Date.now();
        shuffleStep = 0;
        shuffleInterval = setInterval(() => {
            let elapsedTime = Date.now() - startTime;
            if (elapsedTime >= 11000) {
                clearInterval(shuffleInterval);
                keysClickable = true;
                setTimeout(() => {
                    if (document.getElementById("game").style.display === "block") {
                        showResult(false);
                    }
                }, 5000);
                return;
            }
            shufflePattern();
            shuffleStep++;
        }, 300);
    }

    // New, smoother looping pattern — mimics the “video” look
    function shufflePattern() {
        const patterns = [
            [4,5,6,7,0,1,2,3], // shift halves
            [1,0,3,2,5,4,7,6], // swap pairs
            [2,3,0,1,6,7,4,5], // rotate left
            [3,2,1,0,7,6,5,4], // reverse each row
            [0,2,1,3,4,6,5,7], // zigzag swap
            [5,4,7,6,1,0,3,2], // flip pattern
        ];

        let pattern = patterns[shuffleStep % patterns.length];

        keys.forEach((key, i) => {
            let newPos = pattern[i];
            let row = Math.floor(newPos / 4);
            let col = newPos % 4;
            key.style.transition = "transform 0.25s ease"; // smoother motion
            key.style.transform = `translate(${col * 60 - (i % 4) * 60}px, ${row * 120 - Math.floor(i / 4) * 120}px)`;
        });
    }

    function checkKey(index) {
        clearInterval(shuffleInterval);
        showResult(index === correctKeyIndex);
    }

    function showResult(win) {
        document.getElementById("game").style.display = "none";
        document.getElementById("result").style.display = "block";
        document.getElementById("resultText").textContent = win ? "YOU WIN!" : "YOU LOSE!";
        if (!win) {
            audio.pause();
        }
    }

    function restartGame() {
        document.getElementById("result").style.display = "none";
        document.querySelector("button").style.display = "block";
        keys.forEach(key => {
            key.style.backgroundImage = 'url("Key.png")';
            key.style.transform = '';
        });
        audio.currentTime = 0;
        audio.pause();
        keysClickable = false;
    }
</script>
